<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DivumWX services.json Generator</title>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script src="https://unpkg.com/esri-leaflet@2.5.1/dist/esri-leaflet.js"></script>
        <script src="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.css" />
        <style>
            body {
                background-color: #FFFFFF;
                color: #333333;
                margin: 0;
                padding: 0;
                background-image: url('./img/background.png');
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                height: 100vh;
            }
            .nav-tabs .nav-link.active, .nav-tabs .nav-link.show {
                background-color: #007BFF !important;
                border-color: #007BFF !important;
                color: #FFFFFF !important;
            }
            .nav-tabs .nav-link {
                border: 1px solid #D9D9D9 !important;
                border-radius: 0.25rem 0.25rem 0 0 !important;
            }
            .nav-pills .nav-link.active, .nav-pills .nav-link.show {
                background-color: #007BFF !important;
            }
            .nav-pills .nav-link {
                background-color: #5A5C5E;
                color: #FFFFFF;
                transition: background-color 0.3s;
            }
            .nav-pills .nav-link:hover {
                background-color: #6c757d;
                color: #FFFFFF;
            }
            .btn-primary {
                background-color: #5A5C5E;
                border-color: #5A5C5E;
            }
            .btn-accent {
                background-color: #007BFF;
                border-color: #007BFF;
                color: #FFFFFF;
            }
            #finishBtn.btn-accent {
                background-color: #007BFF;
                border-color: #007BFF;
                color: #FFFFFF;
                display: none;
            }
            .btn:hover {
                background-color: #9d9b9f; /* Change this to the desired color on hover */
            }
            .progress-bar {
                background-color: #007BFF;
            }
            .tab-pane {
                display: none;
            }
            .tab-pane.active {
                display: block;
            }
            .text-center {
                display: flex;
                justify-content: center;
                align-items: center;
            }
            #map {
                height: 600px;
                width: 1020px;
                border: 2px solid black;
                box-shadow: 3px 3px 5px #8e8c8c;
            }
            .form-control {
                height: 30px;
                padding: 0.25rem 0.5rem;
                font-size: 12px;
            }
            label {
                font-size: 12px;
            }
            .tooltip {
                max-width: 600px!important;
            }
            .tooltip .tooltip-inner {
                background: #1c3a69;
            }
            .tooltip.bs-tooltip-end .tooltip-arrow::before {
                border-right-color: #1c3a69!important;
            }
            .tooltip.tooltip.start .tooltip-arrow::before {
                border-left-color: #1c3a69!important;
            }
            .tooltip.bs-tooltip-bottom .tooltip-arrow::before {
                border-bottom-color: #1c3a69!important;
            }
            .tooltip.bs-tooltip-top .tooltip-arrow::before {
                border-top-color: #1c3a69!important;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h3 class="text-center mb-3">DivumWX services.json Generator</h3>
            <div class="d-flex justify-content-start align-items-center mb-4">
                <div style="margin-right: 10px;">
                    <img src="./img/divumLogo.svg" alt="DivumWX Logo" width="100" height="100" class="mr-3">
                </div>
                <div>
                    <p class="mb-0" style="font-size: 16px;">This form is designed to create the required <b>services.json</b> file for the WeeWX DivumWX skin installation. Stepping through the wizard, fill out the the requested information. Each one of the optional inputs has a Yes/No radio button. The default is No and the text input field is disabled. You may leave them empty if you do not have that service. If you want more information, there is a link you can visit for each one of them in the description. When you've reached the end of the wizard, click on the finish button. This will automatically send you the file called <i><b>settings.json</b></i> which you can save to your default download (or any) folder. Then follow the direction at the DivumWX github site for the skin installation.</p>
                </div>
            </div>
            <ul class="nav nav-tabs">
                <li class="nav-item"><a class="nav-link disabled" href="#step1">Step 1</a></li>
                <li class="nav-item"><a class="nav-link disabled" href="#step2">Step 2</a></li>
                <li class="nav-item"><a class="nav-link disabled" href="#step3">Step 3</a></li>
                <li class="nav-item"><a class="nav-link disabled" href="#step4">Step 4</a></li>
                <li class="nav-item"><a class="nav-link disabled" href="#step5">Step 5</a></li>
            </ul>
            <div class="progress mt-2">
                <div id="progressBar" class="progress-bar" style="width:0"></div>
            </div>
            <form id="settingsForm">
            <div class="tab-content">
                <div id="step1" class="container tab-pane active"><br />
                    <h6 style="text-align: center"> Weather Station Location, Language and IP Address Section</h6>
                    <p class="mb-4" style="font-size: 16px; text-align: center;">You may either click on the Search Icon on the left side of the map and enter your address to search for it, or zoom in using the +/- buttons or your mouse wheel and click on the map to pick your Lat/Long.</p>
                    <div class="text-center">
                        <div id="map"></div>
                        <script>
                            const map = L.map('map').setView([36, 0], 2);
                            L.tileLayer('https://tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey=cbe504c1750c49ae8696f79dca8322e6', {
                                attribution: 'Maps &copy <a href="https://www.thunderforest.com">Thunderforest</a>, Data &copy <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(map);

                            const geocoder = L.esri.Geocoding.geosearch().addTo(map);
                            let marker = L.marker([36, 0], { draggable: true });
                            let markerAdded = false;

                            const addMarkerToMap = (lat, lng) => {
                                if (!markerAdded) {
                                    marker.addTo(map);
                                    markerAdded = true;
                                }
                                marker.setLatLng([lat, lng]);
                                const currentZoom = map.getZoom();
                                map.setView([lat, lng], currentZoom);
                            };

                            const determineHemispheres = (lat, lng) => {
                                let latitudeHemisphere = lat >= 0 ? 'North' : 'South';
                                let longitudeHemisphere = lng >= 0 ? 'East' : 'West';
                                console.log(`Latitude Hemisphere: ${latitudeHemisphere}, Longitude Hemisphere: ${longitudeHemisphere}`);
                                document.getElementById('wsLatHemisphere').value = latitudeHemisphere;
                                document.getElementById('wsLongHemisphere').value = longitudeHemisphere;
                            };

                            const isWithinUK = (lat, lng) => {
                                const ukLatitudeMin = 49.9;
                                const ukLatitudeMax = 60.9;
                                const ukLongitudeMin = -8.6;
                                const ukLongitudeMax = 1.8;
                                return lat >= ukLatitudeMin && lat <= ukLatitudeMax && lng >= ukLongitudeMin && lng <= ukLongitudeMax;
                            };

                            const isWithinAu = (lat, lng) => {
                                const auLatitudeMin = -43.7; // Extending to include Tasmania
                                const auLatitudeMax = -10.6;
                                const auLongitudeMin = 113.3;
                                const auLongitudeMax = 153.6;
                                return lat >= auLatitudeMin && lat <= auLatitudeMax && lng >= auLongitudeMin && lng <= auLongitudeMax;
                            };

                            const getTimezone = (lat, lng) => {
                                const apiKey = 'R3OG8S9U4K7P';
                                const apiUrl = `https://api.timezonedb.com/v2.1/get-time-zone?key=${apiKey}&format=json&by=position&lat=${lat}&lng=${lng}`;

                                fetch(apiUrl)
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.status === "OK") {
                                            const timezoneName = data.zoneName;
                                            console.log(`Timezone: ${timezoneName}`);
                                            document.getElementById('wsTimeZone').value = timezoneName;
                                        } else {
                                            console.error('Error fetching timezone:', data.message);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                    });
                            };

                            function updateDropdownWithMetar() {
                                let icaoCount = 0;
                                var apiKey = '13044ead145d48d0b9d067cb67';
                                var lat = $('#wsLat').val();
                                var lng = $('#wsLong').val();
                                var url = `https://api.checkwx.com/metar/lat/${lat}/lon/${lng}/radius/100?x-api-key=${apiKey}`;

                                $.get(url, function(data) {
                                    if (data && data.results > 0 && Array.isArray(data.data)) {
                                        let icaoCodes = data.data.map(function(metar) {
                                            return metar.slice(0, 4);
                                        });

                                        icaoCount = icaoCodes.length;
                                        $('#icaoCountField').val(icaoCount);
                                        $('#airportCountMessage').text(`There are only '${icaoCount}' airports within a 100-mile radius of your current Latitude and Longitude that provide METAR data.`);
                                        $('#localAirportICAO').empty();
                                        var defaultOption = $('<option></option>').attr('value', '').text('--- Select the closest Airport to You ---');
                                        $('#localAirportICAO').append(defaultOption);
                                        icaoCodes.forEach(function(icaoCode) {
                                            fetchStationInfo(icaoCode);
                                        });
                                    } else {
                                        console.error('No METAR data found');
                                        $('#localAirportICAO').append($('<option></option>').attr('value', '').text('No METAR data found'));
                                    }
                                }).fail(function() {
                                    console.error('Failed to fetch METAR data');
                                    $('#localAirportICAO').append($('<option></option>').attr('value', '').text('Failed to fetch METAR data'));
                                });
                            }

                            function fetchStationInfo(icaoCode) {
                                var apiKey = '13044ead145d48d0b9d067cb67';
                                var url = `https://api.checkwx.com/station/${icaoCode}?x-api-key=${apiKey}`;

                                $.get(url, function(data) {
                                    if (data && data.results > 0 && data.data.length > 0) {
                                        let station = data.data[0];
                                        let optionText = `${station.name} (${station.icao}), ${station.location}`;
                                        let option = $('<option></option>').attr('value', station.icao).text(optionText);
                                        $('#localAirportICAO').append(option);  // Add station info to the dropdown
                                    } else {
                                        console.error(`No station data found for ${icaoCode}`);
                                    }
                                }).fail(function() {
                                    console.error(`Failed to fetch station data for ${icaoCode}`);
                                });
                            }

                            geocoder.on('results', (results) => {
                                if (results.results.length > 0) {
                                    const result = results.results[0];
                                    const latPrecise = result.latlng.lat.toFixed(6);
                                    const lngPrecise = result.latlng.lng.toFixed(6);
                                    const lat = result.latlng.lat.toFixed(4);
                                    const lng = result.latlng.lng.toFixed(4);
                                    document.getElementById('dvmlatPrecise').value = latPrecise;
                                    document.getElementById('dvmlngPrecise').value = lngPrecise;
                                    document.getElementById('wsLat').value = lat;
                                    document.getElementById('wsLong').value = lng;
                                    addMarkerToMap(lat, lng);
                                    determineHemispheres(lat, lng);
                                    if (isWithinUK(lat, lng)) {
                                        console.log("The coordinates are within the UK.");
                                        document.getElementById('wsIsWithinUK').value = 'true';
                                    } else {
                                        console.log("The coordinates are outside the UK.");
                                        document.getElementById('wsIsWithinUK').value = 'false';
                                    }
                                    if (isWithinAu(lat, lng)) {
                                        console.log("The coordinates are within Australia.");
                                        document.getElementById('wsIsWithinAu').value = 'true';
                                    } else {
                                        console.log("The coordinates are outside Australia.");
                                        document.getElementById('wsIsWithinAu').value = 'false';
                                    }
                                    updateDropdownWithMetar();
                                    getTimezone(lat, lng);
                                }
                            });

                            map.on('click', (e) => {
                                const latPrecise = e.latlng.lat.toFixed(6);
                                const lngPrecise = e.latlng.lng.toFixed(6);
                                const lat = e.latlng.lat.toFixed(4);
                                const lng = e.latlng.lng.toFixed(4);
                                document.getElementById('dvmlatPrecise').value = latPrecise;
                                document.getElementById('dvmlngPrecise').value = lngPrecise;
                                document.getElementById('wsLat').value = lat;
                                document.getElementById('wsLong').value = lng;
                                addMarkerToMap(lat, lng);
                                determineHemispheres(lat, lng);
                                if (isWithinUK(lat, lng)) {
                                    console.log("The coordinates are within the UK.");
                                    document.getElementById('wsIsWithinUK').value = 'Yes';
                                } else {
                                    console.log("The coordinates are outside the UK.");
                                    document.getElementById('wsIsWithinUK').value = 'No';
                                }
                                if (isWithinAu(lat, lng)) {
                                    console.log("The coordinates are within Australia.");
                                    document.getElementById('wsIsWithinAu').value = 'true';
                                } else {
                                    console.log("The coordinates are outside Australia.");
                                    document.getElementById('wsIsWithinAu').value = 'false';
                                }
                                updateDropdownWithMetar();
                                getTimezone(lat, lng);
                            });

                            marker.on('moveend', (e) => {
                                const latPrecise = e.target.getLatLng().lat.toFixed(6);
                                const lngPrecise = e.target.getLatLng().lng.toFixed(6);
                                const lat = e.target.getLatLng().lat.toFixed(4);
                                const lng = e.target.getLatLng().lng.toFixed(4);
                                document.getElementById('dvmlatPrecise').value = latPrecise;
                                document.getElementById('dvmlngPrecise').value = lngPrecise;
                                document.getElementById('wsLat').value = lat;
                                document.getElementById('wsLong').value = lng;
                                addMarkerToMap(lat, lng);
                                determineHemispheres(lat, lng);
                                if (isWithinUK(lat, lng)) {
                                    console.log("The coordinates are within the UK.");
                                    document.getElementById('wsIsWithinUK').value = 'Yes';
                                } else {
                                    console.log("The coordinates are outside the UK.");
                                    document.getElementById('wsIsWithinUK').value = 'No';
                                }
                                if (isWithinAu(lat, lng)) {
                                    console.log("The coordinates are within Australia.");
                                    document.getElementById('wsIsWithinAu').value = 'true';
                                } else {
                                    console.log("The coordinates are outside Australia.");
                                    document.getElementById('wsIsWithinAu').value = 'false';
                                }
                                updateDropdownWithMetar();
                                getTimezone(lat, lng);
                            });

                        </script>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-4 form-group">
                            <label for="wsLat">Weather Station Latitude:</label>
                            <input type="text" class="form-control" id="wsLat" name="wsLat" readonly data-bs-toggle="tooltip" data-bs-title="This field is read only and is filled when you click on your location on the map above" data-bs-delay="1000" required>
                            <input type="hidden" id="wsLatHemisphere" value="">
                            <input type="hidden" id="dvmlatPrecise" value="">
                            
                        </div>
                        <div class="col-md-4 form-group">
                            <label for="wsLong">Weather Station Longitude:</label>
                            <input type="text" class="form-control" id="wsLong" name="wsLong" readonly data-bs-toggle="tooltip" data-bs-title="This field is read only and is filled when you click on your location on the map above" data-bs-delay="1000" required>
                            <input type="hidden" id="wsLongHemisphere" value="initialValue">
                            <input type="hidden" id="dvmlngPrecise" value="initialValue">
                        </div>
                        <div class="col-md-4 form-group">
                            <label for="wsAlt">Weather Station Altitude:</label>
                            <input type="text" class="form-control" id="wsAlt" name="wsAlt" data-bs-toggle="tooltip" data-bs-title="Please enter the Ground surface height above sea level in whole meters (integers)" data-bs-delay="1000" required>
                        </div>
                        <input type="hidden" id="wsIsWithinUK" value="">
                        <input type="hidden" id="wsIsWithinAu" value="">
                        <input type="hidden" id="wsTimeZone" value="">
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                            <label for="wsLang">Weather Station Language</label>
                            <select class="form-control" id="wsLang" name="wsLang" required>
                                <option value=""> &lt;-- Please select Language --&gt; </option>
                                <option value="en">English</option>
                                <option value="de">German</option>
                                <option value="fr">French</option>
                                <option value="es">Spanish</option>
                                <option value="it">Italian</option>
                                <option value="br">Portuguese (Br)</option>
                                <option value="ru">Russian</option>
                            </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="wsExtIP">Weather Station External IP:</label>
                                <input type="text" class="form-control" id="wsExtIP" name="wsExtIP" placeholder="Optional - Format: 1.1.1.1 or www.yourdomain.com" data-bs-toggle="tooltip" data-bs-title="This is the public facing IP address of your weather station, typically something like 238.34.78.xx. You may enter the FQDN of your weather station and I'll find the IP address for you, or you can enter the external ip address directly." data-bs-delay="1000" onblur="validateExtAddr()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="wsIntIP">Weather Station Internal IP:</label>
                                <input type="text" class="form-control" id="wsIntIP" name="wsIntIP" placeholder="Optional - Format: 1.1.1.1" data-bs-toggle="tooltip" data-bs-title="This is the internal LAN address of your weather station, normally a 192.168.x.x or a 10.10.x.x address" data-bs-delay="1000">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="step2" class="container tab-pane"><br />
                    <h6 style="text-align: center">XWeather Access ID/Secret Key Entry Section (Required)</h6>
                    <p class="mb-4" style="font-size: 16px; text-align: center;">This section is <b>required</b> for forecasting in the DivumWX skin. You can find out more info <a href="https://www.xweather.com/" target="_blank" rel="noopener noreferrer">here</a>.</br>If you do not signup for a Free API Key, available <a href="https://www.xweather.com/signup/pws/" target="_blank" rel="noopener noreferrer">here</a>, forecasting will not operate. Please ensure that you enter your XWeather Access ID and Secret Key below.</p>
                    <div class="form-group">
                        <label for="awKey">XWeather Access ID:</label>
                        <input type="text" class="form-control" id="awKey" placeholder="Required" required>
                        <label for="awSecret">XWeather Secret Key:</label>
                        <input type="text" class="form-control" id="awSecret" placeholder="Required" required>
                    </div>
                </div>
                <div id="step3" class="container tab-pane"><br />
                    <h6 style="text-align: center">Purple Air API Key Entry</h6>
                    <p class="mb-4" style="font-size: 16px; text-align: center;">This section is for Air Pollution tracking via a Purple Air device. Enable the Purple Air device below and enter the Purple Air Key.<br />Purple Air details can be found <a href="https://www2.purpleair.com/community/faq" target="_blank" rel="noopener noreferrer">here.</a></p>
                    <div class="form-group">
                        <label for="purpleAirKey" class="control-label">Purple Air Key:</label>
                        <div class="form-check-inline ml-3">
                            <input class="form-check-input" type="radio" id="purpleAirKeyEnable" name="purpleAirKeyRadio" value="yes">
                            <label class="form-check-label" for="purpleAirKeyEnable">Yes</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="radio" id="purpleAirKeyDisable" name="purpleAirKeyRadio" value="no" checked>
                            <label class="form-check-label" for="purpleAirKeyDisable">No</label>
                        </div>
                            <input type="text" class="form-control mt-2" id="purpleAirKey" disabled>
                    </div>
                </div>
                <div id="step4" class="container tab-pane"><br />
                <h6 style="text-align: center">Aviation Weather (CheckWX) API</h6>
                    <p class="mb-4" style="font-size: 16px; text-align: center;">This section is for Aviation Weather tracking in the DivumWX skin. It is acceptable to leave both this disabled and the ICAO (International Civil Aviation Organization) empty as it is optional. However, if you enable this and enter your API, you must select an Airport from the auto populated ICAO dropdown box. When you entered the Lat/Long of your weather station, this dropdown was populated with Airports in a 100 mile radius.</br>Details on the Aviation Weather API can be found <a href="https://www.checkwxapi.com/documentation" target="_blank" rel="noopener noreferrer">here</a> and an account can be created <a href="https://www.checkwxapi.com/auth/signup" target="_blank" rel="noopener noreferrer">here.</a></p>
                    <p class="mb-4" style="font-size: 16px; text-align: center;" id="airportCountMessage">There are only 'X' airports within a 100-mile radius of your current Latitude and Longitude, that provide a METAR service.</p>
                    <div class="form-group">
                        <label for="cwxKey" class="control-label">CheckWX Key:</label>
                        <div class="form-check-inline ml-3">
                            <input class="form-check-input" type="radio" id="checkwxKeyEnable" name="checkwxKeyRadio" value="yes">
                            <label class="form-check-label" for="checkwxKeyEnable">Yes</label>
                        </div>
                        <div class="form-check-inline">
                            <input class="form-check-input" type="radio" id="checkwxKeyDisable" name="checkwxKeyRadio" value="no" checked>
                            <label class="form-check-label" for="checkwxKeyDisable">No</label>
                        </div>
                            <input type="text" class="form-control mt-2" id="cwxKey" disabled>
                    </div>
                    <div class="form-group">
                        <label for="localAirportICAO" class="control-label">ICAO (International Civil Aviation Organization code of Nearest Airport) Code:</label>
                        <select class="form-control" id="localAirportICAO" disabled>
                            <option selected disabled value="">--- Select the closest Airport to You ---</option>
                        </select>
                    </div>
                </div>
                <div id="step5" class="container tab-pane"><br />
                    <div style="text-align: center">
                        <h6 style="text-align: center">Active Web Services Code.</h6>
                    </div>
                    <hr>                
                    <div style="text-align: center">
                        When you click on the Finish button, your settings.json file will be presented to you for download. Once you've downloaded it, you may return to the DivumWX installations and continue.
                    </div>
                </div>
            </div> <!-- End tab-content -->
            </form>
            <div class="d-flex justify-content-between mt-3">
                <div>
                    <button id="prevBtn" class="btn btn-accent">Previous</button>
                </div>
                <div>
                    <button id="nextBtn" class="btn btn-accent">Next</button>
                    <button id="finishBtn" class="btn btn-accent" style="display: none;">Finish</button>
                </div>
            </div>
        </div> <!-- End container -->
        <script>//Custom Modal window
            let customModal = null;
            function showCustomModal(errorMessage) {
                if (customModal) {
                    const modalMessage = customModal.querySelector('#modalMessage');
                    modalMessage.textContent = errorMessage;
                    const modal = bootstrap.Modal.getInstance(customModal);
                    modal.show();
                } else {
                    const modalHTML = `
                    <div class="modal fade" id="customModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content border border-primary rounded-lg">
                            <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Warning</h5>
                            </div>
                            <div class="modal-body">
                            <p id="modalMessage">${errorMessage}</p>
                            </div>
                            <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                        </div>
                    </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    customModal = document.getElementById('customModal');
                    const modal = new bootstrap.Modal(customModal);
                    modal.show();
                }
            };
        </script>
        <script>//Tabpanes and normal input validations
            $(document).ready(function() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
                const tabPanes = document.querySelectorAll('.tab-pane');
                const progressBar = document.getElementById('progressBar');
                const firstBtn = document.getElementById('firstBtn');
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const finishBtn = document.getElementById('finishBtn');
                const navLinks = document.querySelectorAll('.nav-link');

                let activeTabIndex = 0;
                function updateUI() {
                    tabPanes.forEach((pane, index) => {
                    pane.classList.toggle('active', index === activeTabIndex);
                    if (activeTabIndex === tabPanes.length - 1) {
                        nextBtn.style.display = 'none';
                        finishBtn.style.display = 'inline-block';
                    } else {
                        nextBtn.style.display = 'inline-block';
                        finishBtn.style.display = 'none';
                    }
                });

                navLinks.forEach((link, index) => {
                    link.classList.toggle('active', index === activeTabIndex);
                });

                progressBar.style.width = `${(activeTabIndex / (tabPanes.length - 1)) * 100}%`;
                }

                prevBtn.addEventListener('click', () => {
                    if (activeTabIndex > 0) {
                        activeTabIndex--;
                    }
                    updateUI();
                });

                nextBtn.addEventListener('click', () => {
                    if (validateInputs()) {
                        activeTabIndex++;
                    }
                    updateUI();
                });
                finishBtn.addEventListener('click', () => {
                    saveFile();
                });
                function validateInputs() {
                    if (activeTabIndex === 0) {
                        const latInput = document.getElementById('wsLat');
                        const longInput = document.getElementById('wsLong');
                        const langInput = document.getElementById('wsLang');
                        const altInput = document.getElementById('wsAlt');
                        const intIPInput = document.getElementById('wsIntIP');
                        if (!latInput.value.trim()) {
                            showCustomModal('You must choose the Weather Station\'s Latitude and Longitude on the Map before proceeding.');
                            return false;
                        }
                        if (!longInput.value.trim()) {
                            showCustomModal('You must choose the Weather Station\'s Latitude and Longitude on the Map before proceeding.');
                            return false;
                        }
                        if (!langInput.value) {
                            showCustomModal('You must first choose the Weather Station\'s language before proceeding.');
                            return false;
                        }
                        if (!altInput.value) {
                            showCustomModal('You must first enter the Weather Station\'s Altitude in meters before proceeding.');
                            return false;
                        }
                        const intIP = intIPInput.value.trim();
                        if (intIP && !validateIPAddress(intIP)) {
                            showCustomModal('The Internal IP that you entered for your Weather Station has an invalid format.');
                            return false;
                        }
                    } else if (activeTabIndex === 1) {
                        const awKeyInput = document.getElementById('awKey');
                        const awSecretInput = document.getElementById('awSecret');
                        if (!awKeyInput.value.trim()) {
                            showCustomModal('You must enter the Aeris Weather Key before proceeding.');
                            return false;
                        }
                        if (!awSecretInput.value.trim()) {
                            showCustomModal('You must enter the Aeris Weather Secret before proceeding.');
                            return false;
                        }
                    } else if (activeTabIndex === 2) {
                        const purpleAirKeyEnable = document.getElementById('purpleAirKeyEnable');
                        const purpleAirKeyInput = document.getElementById('purpleAirKey');
                        if (purpleAirKeyEnable.checked && !purpleAirKeyInput.value.trim()) {
                            showCustomModal('You must enter the Purple Air Key before proceeding.');
                            return false;
                        }
                    } else if (activeTabIndex === 3) {
                        const checkwxKeyEnable = document.getElementById('checkwxKeyEnable');
                        const checkwxKeyInput = document.getElementById('cwxKey');
                        const localAirportICAOInput = document.getElementById('localAirportICAO');
                        if (checkwxKeyEnable.checked && !checkwxKeyInput.value.trim()) {
                            showCustomModal('You must enter the CheckWX Key before proceeding.');
                            return false;
                        }
                        if (checkwxKeyEnable.checked && !localAirportICAOInput.value) {
                            showCustomModal('You must select the closest Airport from the dropdown before proceeding.');
                            return false;
                        }
                    }
                    return true;
                }
                function validateIPAddress(ipAddress) {
                    const ipv4Regex = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
                    return ipv4Regex.test(ipAddress);
                }
                updateUI();
            });
        </script>
        <script>//Handle External IP/URL input in Tab 1
            function validateExtAddr() {
                var input = document.getElementById('wsExtIP').value;
                var urlData = isValidUrl(input);
                if (urlData) {
                    resolveFqdnToIp(urlData.varDomain);
                } else if (isValidIp(input)) {
                    document.getElementById('wsExtIP').value = input;
                } else {
                    showCustomModal('The input you entered is invalid, please try again.');
                }
            }

            function isValidUrl(string) {
                var urlPattern = new RegExp('^(https?:\\/\\/)?'+
                                            '((([a-zA-Z\\d]([a-zA-Z\\d-]*[a-zA-Z\\d])*)\\.)+[a-zA-Z]{2,})'+
                                            '(\\:\\d+)?(\\/[-a-zA-Z\\d%_.~+]*)*'+
                                            '(\\?[;&a-zA-Z\\d%_.~+=-]*)?'+
                                            '(\\#[-a-zA-Z\\d_]*)?$','i');
                if (urlPattern.test(string)) {
                    var varURL = string.match(/^https?:\/\//) ? string : 'http://' + string;
                    var varDomain = string.replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0];
                    return { varURL, varDomain };
                }
                return null;
            }

            function isValidIp(string) {
                var ipPattern = new RegExp('^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}' +
                                        '(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$');
                if (!ipPattern.test(string)) return false;

                var parts = string.split('.').map(function(str) { return parseInt(str); });
                return !(
                    (parts[0] === 10) ||
                    (parts[0] === 172 && (parts[1] >= 16 && parts[1] <= 31)) ||
                    (parts[0] === 192 && parts[1] === 168)
                );
            }

            function resolveFqdnToIp(domain) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            if (response.status === 'success') {
                                document.getElementById('wsExtIP').value = response.ip;
                            } else {
                                console.error("Error: " + response.message);
                            }
                        } else {
                            console.error("Error: " + xhr.statusText);
                        }
                    }
                };
                xhr.open("POST", "./resolveFQDN.php", true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.send(JSON.stringify({ domain: domain }));
            }

            function makeAjaxRequest(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        callback(xhr.responseText, xhr.status);
                    }
                };
                xhr.open('GET', url, true);
                xhr.send();
            }
        </script>
        <script>//Various input field validations and manipulations
            $(document).ready(function() {
                $("input[name='purpleAirKeyRadio']").change(function() {
                    if ($("#purpleAirKeyEnable").is(":checked")) {
                        $("#purpleAirKey").prop("disabled", false);
                        $("#ckpu").prop("checked", true);
                    }
                    else if ($("#purpleAirKeyDisable").is(":checked")) {
                        $("#purpleAirKey").prop("disabled", true);
                        $("#purpleAirKey").val("");
                        $("#ckpu").prop("checked", false);
                    }
                });

                $("input[name='checkwxKeyRadio']").change(function() {
                    if ($("#checkwxKeyEnable").is(":checked")) {
                        $("#cwxKey").prop("disabled", false);
                        $("#localAirportICAO").prop("disabled", false);
                        $("#ckme").prop("checked", true);
                    }
                    else if ($("#checkwxKeyDisable").is(":checked")) {
                        $("#cwxKey").prop("disabled", true);
                        $("#cwxKey").val("");
                        $("#localAirportICAO").prop("disabled", true);
                        $("#localAirportICAO").prop('selectedIndex', 0);
                        $("#ckme").prop("checked", false);
                    }
                });
            });
        </script>
        <script>//Selects Airports within 100km of selected Weather Station Location
            function chkICAODropdown() {
                var checkwxKeyEnable = document.getElementById('checkwxKeyEnable');
                var localAirportICAO = document.getElementById('localAirportICAO');

                if (checkwxKeyEnable.checked) {
                    var hasOptionsOtherThanDefault = false;
                    var hasNonNullValue = false;

                    for (var i = 0; i < localAirportICAO.options.length; i++) {
                        var option = localAirportICAO.options[i];
                        if (option.value !== "" && option.value !== "null") {
                            hasOptionsOtherThanDefault = true;
                            if (option.value !== "") {
                            hasNonNullValue = true;
                            break;
                            }
                        }
                    }

                    if (!hasOptionsOtherThanDefault) {
                        var errorMessage = "There are no airports within a 100 mile radius of your Weather Station's location.";
                        showCustomModal(errorMessage);
                        resetRadioButtons();
                    } else if (hasOptionsOtherThanDefault && !hasNonNullValue) {
                        var errorMessage = "There are no airports within a 100 mile radius of your Weather Station's location that have a valid ICAO code.";
                        showCustomModal(errorMessage);
                        resetRadioButtons();
                    }
                }
            }

            function resetRadioButtons() {
                var checkwxKeyDisable = document.getElementById('checkwxKeyDisable');
                var checkwxKeyEnable = document.getElementById('checkwxKeyEnable');

                checkwxKeyDisable.checked = true;
                checkwxKeyEnable.checked = false;
            }

            document.addEventListener('DOMContentLoaded', function() {
                var checkwxKeyEnable = document.getElementById('checkwxKeyEnable');
                checkwxKeyEnable.addEventListener('click', chkICAODropdown);
            });

        </script>
        <script>//Sets tooltips
            document.addEventListener('DOMContentLoaded', function() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });
            });
        </script>
<script>
    let saveFile = () => {
        const elements = {
            lat: document.getElementById('wsLat'),
            long: document.getElementById('wsLong'),
            latPrecise: document.getElementById('dvmlatPrecise'),
            lngPrecise: document.getElementById('dvmlngPrecise'),           
            alt: document.getElementById('wsAlt'),
            latHemi: document.getElementById('wsLatHemisphere'),
            longHemi: document.getElementById('wsLongHemisphere'),
            isWithinUK: document.getElementById('wsIsWithinUK'),
            isWithinAu: document.getElementById('wsIsWithinAu'),
            timeZone: document.getElementById('wsTimeZone'),
            lang: document.getElementById('wsLang'),
            extIP: document.getElementById('wsExtIP'),
            intIP: document.getElementById('wsIntIP'),
            aw_apikey: document.getElementById('awKey'),
            aw_apisecret: document.getElementById('awSecret'),
            pu_id: document.getElementById('purpleAirKey'),
            me_key: document.getElementById('cwxKey'),
            me_code: document.getElementById('localAirportICAO'),
            enable: "True"
        };

        let inUk = elements.isWithinUK && elements.isWithinUK.value.toLowerCase() === "true";
        let inAu = elements.isWithinAu && elements.isWithinAu.value.toLowerCase() === "true";
        let yesPU = elements.pu_id && elements.pu_id.value ? true : false;
        let yesCWX = elements.me_key && elements.me_key.value ? true : false;

        const txtServices = 'airquality.awa.awc.awd.awh.awm.awp.eq.flood.ki.me.mg';
        let data = {
            lat: elements.lat.value,
            long: elements.long.value,
            latPrecise: elements.latPrecise.value,
            lngPrecise:elements.lngPrecise.value,
            alt: elements.alt.value,
            latHemi: elements.latHemi.value,
            longHemi: elements.longHemi.value,
            isWithinUK: elements.isWithinUK.value,
            isWithinAu: elements.isWithinAu.value,
            timeZone: elements.timeZone.value,
            lang: elements.lang.value,
            aw_apikey: elements.aw_apikey.value,
            aw_apisecret: elements.aw_apisecret.value,
            ...(yesPU ? {
                pu_id: elements.pu_id.value,
            } : {}),
            ...(yesCWX ? {
                me_key: elements.me_key.value,
                me_code: elements.me_code.value,
            } : {}),
            srv_inip: elements.intIP.value,
            srv_exip: elements.extIP.value,
            sub_fields: "lat,long,latPrecise,lngPrecise,alt,lang,cld_continent,aw_apikey,aw_apisecret,me_key,me_code,pu_id,srv_inip,srv_exip",
            config_entries5: {
                DivumWXWebServices: {
                    airquality_url: `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${elements.lat.value}&longitude=${elements.long.value}&current=european_aqi, us_aqi, pm10, pm2_5, carbon_monoxide, nitrogen_dioxide, sulphur_dioxide, ozone, aerosol_optical_depth, dust, ammonia, alder_pollen, birch_pollen, grass_pollen, mugwort_pollen, olive_pollen, ragweed_pollen&timezone=${elements.timeZone.value}`,
                    airquality_interval: "3600",
                    awa_url: `https://data.api.xweather.com/alerts/${elements.lat.value},${elements.long.value}?format=json&limit=10&lang=en&client_id=${elements.aw_apikey.value}&client_secret=${elements.aw_apisecret.value}`,
                    awa_interval: "3600",
                    awc_url: `https://data.api.xweather.com/conditions/${elements.lat.value},${elements.long.value}?format=json&plimit=1&filter=1min&client_id=${elements.aw_apikey.value}&client_secret=${elements.aw_apisecret.value}`,
                    awc_interval: "300",
                    awh_url: `https://data.api.xweather.com/forecasts/${elements.lat.value},${elements.long.value}?filter=1hr&limit=24&client_id=${elements.aw_apikey.value}&client_secret=${elements.aw_apisecret.value}`,
                    awh_interval: "1800",
                    awd_url: `https://data.api.xweather.com/forecasts/${elements.lat.value},${elements.long.value}?filter=daynight&limit=16&client_id=${elements.aw_apikey.value}&client_secret=${elements.aw_apisecret.value}`,
                    awd_interval: "3600",
                    awp_url: `https://data.api.xweather.com/phrases/summary/${elements.lat.value},${elements.long.value}?limit=3&client_id=${elements.aw_apikey.value}&client_secret=${elements.aw_apisecret.value}`,
                    awp_interval: "1800",
                    eq_url: `https://www.seismicportal.eu/fdsnws/event/1/query?limit=50&lat=${elements.lat.value}&lon=${elements.long.value}&maxradius=180&minradius=10&format=json&minmag=2`,
                    eq_interval: "3600",
                    ...(inUk ? {
                        flood_url: `https://environment.data.gov.uk/flood-monitoring/id/floods?lat=${elements.lat.value}&long=${elements.long.value}&dist=10`,
                        flood_interval: "900"
                    } : {}),
                    ki_url: `https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json`,
                    ki_interval: "21600",
                    ...(yesCWX ? {
                        me_url: `https://api.checkwx.com/metar/${elements.me_code.value}/decoded`,
                        me_header: `X-API-Key:${elements.me_key.value}`,
                        me_interval: "3600"
                    } : {}),
                    no_url: `https://api.met.no/weatherapi/locationforecast/2.0/complete?lat=${elements.lat.value}&lon=${elements.long.value}&altitude=${elements.alt.value}`,
                    no_interval: "1800",
                    ...(yesPU ? {
                        pu_url: `https://www.purpleair.com/json?show=${elements.pu_id.value}`,
                        pu_interval: "3600"
                    } : {}),
                    services: txtServices
                }
            },
            config_entries6: {
                DivumWXSkyObject: {
                enable: "True",
                so_interval: "3600",
                so1_url: `https://www.fourmilab.ch/cgi-bin/Earth?img=NASAmMM.evif&imgsize=320&dynimg=y&opt=-l&lat=${elements.lat.value}&ns=${elements.latHemi.value}&lon=${elements.long.value}&ew=${elements.longHemi.value}&alt=35785&tle=&date=0&utc=&jd=/Earth.jpg`,
                so1_filename: "/var/www/html/divumwx/img/earth-1.jpg",
                so2_url: `https://www.fourmilab.ch/cgi-bin/Earth?img=LRO_100m.evif&imgsize=320&dynimg=y&gamma=1.32&opt=-l&lat=${elements.lat.value}&ns=${elements.latHemi.value}&lon=${elements.long.value}&ew=${elements.longHemi.value}&alt=8527&tle=&date=0&utc=&jd=/Earth.jpg`,
                so2_filename: "/var/www/html/divumwx/img/moon-1.jpg"
        }
    },
        };
        let dataStr = JSON.stringify(data, null, 4);
        const textToBLOB = new Blob([dataStr], { type: 'application/json' });
        const sFileName = 'services.json';
        let newLink = document.createElement("a");
        newLink.download = sFileName;
        newLink.href = window.URL.createObjectURL(textToBLOB);
        newLink.style.display = "none";
        document.body.appendChild(newLink);
        newLink.click();
    }
</script>
        <div style="font-size:small; text-align:center;">&nbsp;Version 3.5.6.45</div>
    </body>
</html>
